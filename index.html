<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRA & KPI Generator for Education</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Dark slate text */
        }
        .container {
            max-width: 960px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue on hover */
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .btn-copy { /* Green button for copy */
            background-color: #22c55e; /* Green */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-copy:hover {
            background-color: #16a34a; /* Darker green on hover */
            transform: translateY(-1px);
        }
        .btn-copy:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .btn-download { /* Purple button for download */
            background-color: #8b5cf6; /* Purple */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-download:hover {
            background-color: #7c3aed; /* Darker purple on hover */
            transform: translateY(-1px);
        }
        .btn-download:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        .message-box.success {
            background-color: #D1FAE5; /* Green-100 */
            color: #065F46; /* Green-800 */
        }
        .message-box.error {
            background-color: #FEE2E2; /* Red-100 */
            color: #991B1B; /* Red-800 */
        }
        .message-box.info {
            background-color: #DBEAFE; /* Blue-100 */
            color: #1E40AF; /* Blue-800 */
        }
    </style>
</head>
<body class="p-6">
    <div class="container mx-auto">
        <header class="text-center mb-10 p-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold mb-2">Interactive KRA & KPI Generator</h1>
            <p class="text-xl font-light">A Brainstorming Tool for Educational Objectives</p>
        </header>

        <section class="card">
            <h2 class="text-2xl font-semibold mb-4 text-blue-700">Explore & Brainstorm!</h2>
            <p class="mb-4 text-gray-700">
                Welcome to this interactive tool designed to help you brainstorm Key Result Areas (KRAs) and Key Performance Indicators (KPIs) for various educational objectives. This application uses Artificial Intelligence to generate suggestions based on the objective you provide.
            </p>
            <p class="mb-6 text-gray-700">
                **Important Note:** The suggestions provided by this tool are for **reference and brainstorming purposes only**. They are generated by an AI and should be critically evaluated by your team for consistency, feasibility, and relevance to your specific organizational context and goals. Think of this as a starting point to spark ideas and discussions within your group!
            </p>

            <div class="mb-4">
                <label for="objectiveInput" class="block text-gray-700 text-sm font-bold mb-2">Enter an Educational Objective:</label>
                <textarea id="objectiveInput" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent resize-y" rows="4" placeholder="e.g., Improve student retention rates in higher education"></textarea>
            </div>
            <div class="flex space-x-4 mb-4">
                <button id="generateBtn" class="btn-primary flex items-center justify-center">
                    Generate KRAs & KPIs
                    <span id="loadingSpinner" class="loading-spinner hidden"></span>
                </button>
                <button id="copyBtn" class="btn-copy flex items-center justify-center">
                    Copy Generated Data
                </button>
                <button id="downloadBtn" class="btn-download flex items-center justify-center">
                    Download as Text File
                </button>
            </div>

            <div id="resultsArea" class="mt-6 p-4 bg-blue-50 rounded-lg shadow-inner hidden">
                <h4 class="text-lg font-bold mb-3 text-blue-800">Suggested KRAs and KPIs:</h4>
                <div id="kpiOutput" class="text-gray-800"></div>
            </div>
            <div id="messageBox" class="message-box hidden" role="alert"></div>
        </section>

        <footer class="text-center mt-10 p-4 text-gray-600 text-sm">
            <p>&copy; 2025 Educational Management Tool. For demonstration purposes only.</p>
        </footer>
    </div>

    <script>
        const LOCAL_STORAGE_KEY = 'kpiGeneratorData';

        // Function to display messages to the user
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'success', 'error', 'info');
            messageBox.classList.add(type);
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // Function to render the generated data to the UI
        function renderGeneratedData(data) {
            const kpiOutput = document.getElementById('kpiOutput');
            const resultsArea = document.getElementById('resultsArea');
            kpiOutput.innerHTML = ''; // Clear previous content

            if (data && data.length > 0) {
                let htmlOutput = '';
                data.forEach(item => {
                    htmlOutput += `<div class="mb-6 p-4 bg-white rounded-lg shadow-sm border border-blue-100">`;
                    htmlOutput += `<h5 class="font-semibold text-blue-700 text-lg mb-1">KRA: ${item.kra}</h5>`;
                    if (item.kraExplanation) {
                        htmlOutput += `<p class="text-gray-600 text-sm mb-3 italic">${item.kraExplanation}</p>`;
                    }
                    
                    htmlOutput += `<div class="mt-4 pt-4 border-t border-blue-200">`;
                    htmlOutput += `<h6 class="font-semibold text-blue-600 text-base mb-2">Key Performance Indicators:</h6>`;
                    htmlOutput += `<ul class="list-disc pl-5 text-gray-700">`;
                    item.kpis.forEach(kpiItem => {
                        htmlOutput += `<li class="mb-2">`;
                        htmlOutput += `<span class="font-medium">${kpiItem.kpi}</span>`;
                        if (kpiItem.kpiExplanation) {
                            htmlOutput += `<p class="text-gray-500 text-xs ml-2 italic">${kpiItem.kpiExplanation}</p>`;
                        }
                        htmlOutput += `</li>`;
                    });
                    htmlOutput += `</ul>`;
                    htmlOutput += `</div>`; // Close KPI section
                    htmlOutput += `</div>`; // Close KRA block
                });
                kpiOutput.innerHTML = htmlOutput;
                resultsArea.classList.remove('hidden');
            } else {
                resultsArea.classList.add('hidden'); // Hide if no data
            }
        }

        // Function to save data to local storage
        function saveDataToLocalStorage(data) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving to local storage:", e);
                showMessage("Could not save data to local storage. Browser storage might be full or disabled.", "error");
            }
        }

        // Function to load data from local storage
        function loadDataFromLocalStorage() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                return storedData ? JSON.parse(storedData) : null;
            } catch (e) {
                console.error("Error loading from local storage:", e);
                showMessage("Could not load previously generated data. Local storage might be corrupted.", "error");
                return null;
            }
        }

        // Load data when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const storedData = loadDataFromLocalStorage();
            if (storedData) {
                renderGeneratedData(storedData);
                // Optionally, populate the objective input if you want to show the last objective
                // document.getElementById('objectiveInput').value = storedData.objective || '';
            }
        });

        document.getElementById('generateBtn').addEventListener('click', async () => {
            const objective = document.getElementById('objectiveInput').value.trim();
            const loadingSpinner = document.getElementById('loadingSpinner');
            const generateBtn = document.getElementById('generateBtn');

            document.getElementById('kpiOutput').innerHTML = ''; // Clear current display
            document.getElementById('resultsArea').classList.add('hidden');
            showMessage('', 'hidden'); // Clear previous messages

            if (!objective) {
                showMessage('Please enter an educational objective.', 'error');
                return;
            }

            loadingSpinner.classList.remove('hidden');
            generateBtn.disabled = true;

            try {
                let chatHistory = [];
                const prompt = `Given the educational objective: '${objective}', suggest 3-5 Key Result Areas (KRAs) and for each KRA, provide a brief explanation of why it's a key result area for this objective. For each KRA, suggest 2-3 measurable Key Performance Indicators (KPIs) and for each KPI, provide a brief explanation of what it measures and why it's relevant. Provide the output as a JSON array of objects, where each object has a 'kra' (string), 'kraExplanation' (string), and 'kpis' (array of objects, each with 'kpi' (string) and 'kpiExplanation' (string)).`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "kra": { "type": "STRING" },
                                    "kraExplanation": { "type": "STRING" },
                                    "kpis": {
                                        "type": "ARRAY",
                                        "items": {
                                            type: "OBJECT",
                                            properties: {
                                                "kpi": { "type": "STRING" },
                                                "kpiExplanation": { "type": "STRING" }
                                            }
                                        }
                                    }
                                },
                                "propertyOrdering": ["kra", "kraExplanation", "kpis"]
                            }
                        }
                    }
                };

                const apiKey = "AIzaSyDBteHDDEtVwCWXabmRER9rkqwAo9FSx5c"; // Provided by Canvas environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);

                    if (parsedJson.length > 0) {
                        saveDataToLocalStorage(parsedJson); // Save to local storage
                        renderGeneratedData(parsedJson); // Render to UI
                    } else {
                        showMessage('No KRAs or KPIs could be generated for this objective. Please try a different objective.', 'info');
                    }
                } else {
                    showMessage('Failed to generate KRAs and KPIs. Please try again.', 'error');
                }

            } catch (error) {
                console.error('Error generating KRAs and KPIs:', error);
                showMessage('An error occurred while generating. Please check your input and try again.', 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
                generateBtn.disabled = false;
            }
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            const objective = document.getElementById('objectiveInput').value.trim();
            const generatedData = loadDataFromLocalStorage(); // Get the currently displayed data

            if (!objective || !generatedData || generatedData.length === 0) {
                showMessage('Please generate KRAs & KPIs first before copying.', 'info');
                return;
            }

            let textToCopy = `Educational Objective: ${objective}\n\n`;

            generatedData.forEach(item => {
                textToCopy += `KRA: ${item.kra}\n`;
                if (item.kraExplanation) {
                    textToCopy += `  Explanation: ${item.kraExplanation}\n`;
                }
                textToCopy += `  KPIs:\n`;
                item.kpis.forEach(kpiItem => {
                    textToCopy += `    - ${kpiItem.kpi}\n`;
                    if (kpiItem.kpiExplanation) {
                        textToCopy += `      (Measures: ${kpiItem.kpiExplanation})\n`;
                    }
                });
                textToCopy += `\n`; // Add a newline between KRA blocks
            });

            // Use a temporary textarea to copy text to clipboard
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                showMessage('Generated data copied to clipboard!', 'success');
            } catch (err) {
                console.error('Failed to copy text:', err);
                showMessage('Failed to copy data. Please try manually selecting and copying.', 'error');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const objective = document.getElementById('objectiveInput').value.trim();
            const generatedData = loadDataFromLocalStorage(); // Get the currently displayed data

            if (!objective || !generatedData || generatedData.length === 0) {
                showMessage('Please generate KRAs & KPIs first before downloading.', 'info');
                return;
            }

            let fileContent = `Educational Objective: ${objective}\n\n`;

            generatedData.forEach(item => {
                fileContent += `KRA: ${item.kra}\n`;
                if (item.kraExplanation) {
                    fileContent += `  Explanation: ${item.kraExplanation}\n`;
                }
                fileContent += `  KPIs:\n`;
                item.kpis.forEach(kpiItem => {
                    fileContent += `    - ${kpiItem.kpi}\n`;
                    if (kpiItem.kpiExplanation) {
                        fileContent += `      (Measures: ${kpiItem.kpiExplanation})\n`;
                    }
                });
                fileContent += `\n`; // Add a newline between KRA blocks
            });

            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const filename = `KRA_KPI_for_${objective.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '_')}.txt`; // Sanitize filename
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href); // Clean up the URL object

            showMessage('Generated data downloaded as a text file!', 'success');
        });
    </script>
</body>
</html>
